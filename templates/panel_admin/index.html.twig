{% extends 'base.html.twig' %}

{% block title %}Votre tableau de bord administrateur
{% endblock %}


{% block body %}

	{% block admin_layout %}
		{{ include('layout/admin_layout.html.twig')}}
	{% endblock %}
	{# LISTE UTILISATEURS#}
	<h1>Votre tableau de bord administrateur</h1>
	<div class="admin-dashboard">
		<h2>Gestion des utilisateurs.</h2>
		<div class="user-table">
			<ul class="user-list">
				{% for user in users %}
					<li class="user-item">
						<div class="user-item-content">
							<p>
								<strong>Pseudo:</strong>
								{{ user.pseudo }}</p>
							<p>
								<strong>Nom:</strong>
								{{ user.nom }}</p>
							<p>
								<strong>Prénom:</strong>
								{{ user.prenom }}</p>
							<p>
								<strong>Email:</strong>
								{{ user.email }}</p>
							<p>
								<strong>Statut:</strong>
								{% if user.isActive %}
									<span class="status-active">Activé</span>
								{% else %}
									<span class="status-inactive">Désactivé</span>
								{% endif %}
							</p>
							<p>
								<strong>Banni:</strong>
								{% if user.isBanned %}
									<span class="banned-yes">Oui</span>
								{% else %}
									<span class="banned-no">Non</span>
								{% endif %}
							</p>
							{% if is_granted('ROLE_ADMIN') %}
								<p>
									<strong>Rôles:</strong>
									{% for role in user.roles %}
										{% if role == 'ROLE_ADMIN' %}
											<span>Admin</span>
										{% elseif role == 'ROLE_USER' %}
											<span>Utilisateur</span>
										{% else %}
											<span>{{ role }}</span>
										{% endif %}
									{% endfor %}
								</p>
							{% endif %}
						</div>
						<div class="user-item-actions">
							{% if user.isBanned == false %}
								<a class="btn-principal" href="{{ path('app_user_ban', {'id': user.id}) }}" onclick="return confirm('Êtes-vous sûr de vouloir bannir l\'utilisateur ?');">Bannir</a>
							{% else %}
								<a class="btn-principal" href="{{ path('app_user_unban', {'id': user.id}) }}" onclick="return confirm('Êtes-vous sûr de vouloir réintégrer l\'utilisateur ?');">Réintégrer</a>
							{% endif %}
							<form action="{{ path('app_admin_user_delete', {'id': user.id}) }}" method="post" onsubmit="return confirm('Êtes-vous sûr de vouloir supprimer cet utilisateur?');">
								<input type="hidden" name="_token" value="{{ csrf_token('delete' ~ user.id) }}">
								<button class="btn-principal" type="submit" data-user-id="{{ user.id }}">Supprimer</button>
							</form>
						</div>
					</li>
				{% endfor %}
			</ul>
			{# Pagination #}
			{% if users.pageCount > 1 %}
				<div class="navigation">
					{{ knp_pagination_render(users) }}
				</div>
			{% endif %}
		</div>


		{# --- Tableau des visites --- #}
		<h2>Gestion des visites.</h2>
		<div class="user-table">
			<ul class="visit-list">
				{% for visite in visites %}
					<li class="visit-item">
						<div class="visit-item-content">
							<p>
								<strong>Pseudo:</strong>
								{{ visite.user.pseudo }}</p>
							<p>
								<strong>Date de la visite:</strong>
								{{ visite.dateVisite ? visite.dateVisite|date('d/m/Y') : '' }}</p>
							<p>
								<strong>Statut:</strong>
								{{ visite.statut }}</p>
							<p>
								<strong>Date de réservation souhaitée:</strong>
								{{ visite.dateResaSouhaite ? visite.dateResaSouhaite|date('d/m/Y') : '' }}</p>
						</div>
						<div class="visit-item-actions">
							{% if visite.statut != 'annulée'and visite.statut !='validée' and (is_granted('ROLE_ADMIN') or app.user == visite.user) %}
								<form method="post" action="{{ path('app_visite_cancel', {'id': visite.id}) }}" onsubmit="return confirm('Êtes-vous sûr de vouloir annuler cette visite ?');">
									<input type="hidden" name="_token" value="{{ csrf_token('cancel' ~ visite.id) }}">
									<button class="btn-principal">Annuler</button>
								</form>
							{% endif %}
							{% if is_granted('ROLE_ADMIN') and visite.statut == 'en_attente' %}
								<form method="post" action="{{ path('app_visite_validate', {'id': visite.id}) }}">
									<input type="hidden" name="_token" value="{{ csrf_token('validate' ~ visite.id) }}">
									<button class="btn-principal">Valider</button>
								</form>
							{% endif %}
							<a class="btn-principal" href="{{ path('app_visite_show', {'id': visite.id}) }}">Voir</a>
							{% if visite.statut == 'en_attente' %}
								<a class="btn-principal" href="{{ path('app_visite_edit', {'id': visite.id}) }}">Modifier</a>
							{% endif %}
						</div>
					</li>
				{% endfor %}
				{# Pagination #}
				{% if visites.pageCount > 1 %}
					<div class="navigation">
						{{ knp_pagination_render(visites) }}
					</div>
				{% endif %}
			</ul>
		</div>


		{# --- Tableau des réservations --- #}
		<h2>Gestion des réservations.</h2>
		<div class="user-table">
			<ul class="reservation-list">
				{% for reservation in reservations %}
					<li class="reservation-item">
						<div class="reservation-item-content">
							<p>
								<strong>Pseudo:</strong>
								{{ reservation.user.pseudo }}</p>
							<p>
								<strong>Début:</strong>
								{{ reservation.dateResaDebut ? reservation.dateResaDebut|date('d/m/Y') : '' }}</p>
							<p>
								<strong>Fin:</strong>
								{{ reservation.dateResaFin ? reservation.dateResaFin|date('d/m/Y') : '' }}</p>
							<p>
								<strong>Dossier:</strong>
								{{ reservation.dossierResa }}</p>
							<p>
								<strong>Statut:</strong>
								{{ reservation.statut }}</p>
							<p>
								<strong>Acompte:</strong>
								{{ reservation.acompte }}</p>
							<p>
								<strong>Caution:</strong>
								{{ reservation.caution }}</p>
							<p>
								<strong>Catégorie:</strong>
								{{ reservation.categorie.nom }}</p>
							<p>
								<strong>Options:</strong>
								{% for option in reservation.options %}
									{{ option.nom }}
								{% else %}
									Aucune option
								{% endfor %}
							</p>
						</div>
						<div
							class="reservation-item-actions">

							{# Le lien Voir est toujours disponible en premier pour l'affichage des détails #}
							<a class="btn-principal" href="{{ path('app_reservation_show', {'id': reservation.id}) }}">Voir</a>

							{# 1. Boutons d'actions Administrateur (remplace l'ancien "Valider") #}
							{% if is_granted('ROLE_ADMIN') %}

								{# Action 1/2 : Envoyer Contrat (Statut: en_attente -> contrat_envoye) #}
								{% if reservation.statut == 'en_attente' %}
									<form method="post" action="{{ path('app_reservation_send_contract', {'id': reservation.id}) }}" onsubmit="return confirm('Confirmer l\'envoi du contrat au client et le passage au statut « contrat_envoye » ?');">
										<input type="hidden" name="_token" value="{{ csrf_token('sendContract' ~ reservation.id) }}">
										<button type="submit" class="btn-principal">Envoyer Contrat</button>
									</form>
								{% endif %}

								{# Action 2/2 : Confirmer (Statut: contrat_envoye -> confirmee) #}
								{% if reservation.statut == 'contrat_envoye' %}
									<form method="post" action="{{ path('app_reservation_confirm', {'id': reservation.id}) }}" onsubmit="return confirm('Confirmer la réception de l\'acompte et le passage au statut « confirmee » ?');">
										<input type="hidden" name="_token" value="{{ csrf_token('confirm' ~ reservation.id) }}">
										<button type="submit" class="btn-principal action-confirm">Confirmer</button>
									</form>
								{% endif %}
							{% endif %}

							{# 2. Bouton Modifier (pour l'utilisateur ou l'admin) #}
							{# On permet la modification uniquement si la réservation est "en_attente" #}
							{% if reservation.statut == 'en_attente' %}
								<a class="btn-principal" href="{{ path('app_reservation_edit', {'id': reservation.id}) }}">Modifier</a>
							{% endif %}

							{# 3. Bouton Annuler #}
							{# On permet l'annulation si le statut est un statut intermédiaire ou confirmé (non annulé) #}
							{% set cancellableStatuses = ['en_attente', 'contrat_envoye', 'confirmee', 'modifiee'] %}
							{% if reservation.statut in cancellableStatuses and (is_granted('ROLE_ADMIN') or app.user == reservation.user) %}
								<form method="post" action="{{ path('app_reservation_cancel', {'id': reservation.id}) }}" onsubmit="return confirm('Êtes-vous sûr de vouloir annuler cette réservation ?');">
									<input type="hidden" name="_token" value="{{ csrf_token('cancel' ~ reservation.id) }}">
									<button type="submit" class="btn-principal">Annuler</button>
								</form>
							{% endif %}
						</div>
					</li>
				{% endfor %}
				{# Pagination #}
				{% if reservations.pageCount > 1 %}
					<div class="navigation">
						{{ knp_pagination_render(reservations) }}
					</div>
				{% endif %}
			</div>
		</ul>
	</div>
{% endblock %}
