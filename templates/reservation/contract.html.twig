{% extends 'base.html.twig' %}

{% block header %}
	<div class="no-print">
		{{ parent() }}
	</div>
{% endblock %}

{% block title %}
	{# Adapte le titre de la page (onglet du navigateur) #}
	{% if reservation.statut == 'en_attente' %}
		Conditions Générales de Location
	{% else %}
		Contrat de Location (Réservation
		{{ reservation.dossierResa }})
	{% endif %}
{% endblock %}

{% block body %}

	{# ------------------------------------------------------------------ #}
	{# BLOC DE REMPLACEMENT CENTRALISÉ (Dictionnaire de Placeholders) #}
	{# Ce bloc définit tous les remplacements Twig une seule fois pour les deux documents. #}
	{% set placeholders = {
        '[[NOM_CLIENT]]': client.nom|upper,
        '[[PRENOM_CLIENT]]': client.prenom,
        '[[PSEUDO_CLIENT]]': client.pseudo,
        '[[EMAIL_CLIENT]]': client.email,
        '[[NUMERO_DOSSIER]]': reservation.dossierResa,
        '[[DATE_DEBUT]]': reservation.dateResaDebut|date('d/m/Y'),
        '[[DATE_FIN]]': reservation.dateResaFin|date('d/m/Y'),
        '[[CATEGORIE_RESERVEE]]': reservation.categorie.nom,
        '[[DATE_DU_JOUR]]': "now"|date('d/m/Y'),
        '[[VILLE_CONTRAT]]': 'Talmont-Saint-Hilaire', 
        '[[CAPACITE_MAX]]': reservation.categorie.capacite|default('Non spécifiée')
    } %}
	{# ------------------------------------------------------------------ #}


		<div class="contract-container"> <header>
			<h1>{{ legal_page.title }}
				- Contrat de Location</h1>
			<div class="logo-container-contract">
				<img src={{asset('img/logo.png')}} alt="SCI LA THÉRÈSIÈRE">
			</div>
		</header>

		<section class="reservation-summary">
			<h2>
				Récapitulatif de la Réservation</h2>
			<ul class="reservation-details-list">
				<li class="detail-item">
					<strong>Dossier n°:</strong>
					{{ reservation.dossierResa }}</li>
				<li class="detail-item">
					<strong>Locataire :
					</strong>
					{{ client.nom }}
					{{ client.prenom }}
					({{ client.email }})</li>
				<li class="detail-item">
					<strong>Période de Location :</strong>
					Du
					{{ reservation.dateResaDebut ? reservation.dateResaDebut|date('d/m/Y') : '' }}
					au
					{{ reservation.dateResaFin ? reservation.dateResaFin|date('d/m/Y') : '' }}
				</li>
				<li class="detail-item">
					<strong>Catégorie Réservée:</strong>
					{{ reservation.categorie.nom }}</li>

			</ul>
			<p>
				<h2>Option Réservée:</h2>
				{% if reservation.options is not empty %}
					<ul class="option-list">
						{% for option in reservation.options %}
							<li>
								<span>{{ option.nom }}</span>
							</li>
						{% endfor %}
					</ul>
				{% else %}
					<p>Aucune option supplémentaire n'a été sélectionnée.</p>
				{% endif %}
			</p>
		</section>

		{# ------------------------------------------------------------------ #}
		{# 1. AFFICHAGE DES CONDITIONS GÉNÉRALES DE LOCATION (CGL) #}
		<section class="contract-content">
			<h2>Conditions Contractuelles</h2>

			{# Application du bloc de remplacement unique aux CGL #}
			{% set contractContent = legal_page.content|replace(placeholders) %}

			<div class="content">
				{{ contractContent|raw }}
			</div>
		</section>
		{# ------------------------------------------------------------------ #}


		{# ------------------------------------------------------------------ #}
		{# 2. AFFICHAGE DU RÈGLEMENT INTÉRIEUR (RI) - ANNEXE #}
			{% if reglement_interieur is defined and reglement_interieur is not null %}
			{# 'page-break-before: always;' force le RI à commencer sur une nouvelle page en impression/PDF #}
				<section class="contract-content reglement-interieur-content" style="page-break-before: always;"> <hr style="margin-top: 50px; margin-bottom: 50px;">

				<h1>{{ reglement_interieur.title }}</h1>

				{# Application du bloc de remplacement unique au RI #}
				{% set riContent = reglement_interieur.content|replace(placeholders) %}

				<div class="content">
					{{ riContent|raw }}
				</div>
			</section>
		{% endif %}
		{# ------------------------------------------------------------------ #}


		<div class="contract-actions no-print">
			<button
				class="btn-principal" onclick="window.print();">
				{# Adapte le texte du bouton #}
				{% if reservation.statut == 'en_attente' %}
					Imprimer les CGL
				{% else %}
					Imprimer/Télécharger le Contrat
				{% endif %}
			</button>
			<a class="btn-principal" href="{{ path('app_reservation_show', {'id': reservation.id}) }}">Retour aux details</a>
		</div>
	</div>
{% endblock %}

{% block footer %}
	<div class="no-print">
		{{ parent() }}
	</div>
{% endblock %}
